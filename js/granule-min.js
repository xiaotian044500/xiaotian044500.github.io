var granule=function(a){this.TWEEN=["easeInOutQuad","easeInOutCubic","easeInOutBack"];this.fontSize=256;this.sett=a;this._init();this.randomCreateAllBall()};granule.prototype._init=function(){var b=document.querySelector(this.sett.el);var a=b.getBoundingClientRect();this.canvas=document.createElement("canvas");this.sett.bgcolorOpacity=this.sett.bgcolorOpacity?this.sett.bgcolorOpacity:1;this.canvas.setAttribute("style","opacity: "+this.sett.bgcolorOpacity);this.cc=this.canvas.getContext("2d");this.ctemp=document.createElement("canvas");this.c2=this.ctemp.getContext("2d");this.cw=parseInt(this.sett.width)||a.width;this.ch=parseInt(this.sett.height)||a.height;this.radius=this.sett.radius||5;this.opacity=this.sett.opacity||1;this.concentration=this.sett.concentration||1;this.duration=this.sett.duration||8;this.rangeRadius=this.sett.rangeRadius||(this.cw+this.ch)/4;this.tweenType=this.sett.tweenType||"";this.tweenAni=this.sett.tweenAni||"easeInOutCubic";this.cg=Math.floor(this.cw*this.ch/(this.radius*this.radius*8*8)*this.concentration);this.color=this.sett.color||"#ffffff";this.bgcolor=this.sett.bgcolor||"#222222";this.canvas.width=this.cw;this.canvas.height=this.ch;this.ctemp.width=this.cw;this.ctemp.height=256;this.ctemp.setAttribute("style","position: absolute;opacity: 0;left: 0;top: 0;z-index: -2;");this.c2.fillStyle="#FF0000";this.c2.font="256px 微软雅黑";this.c2.textBaseline="middle";b.appendChild(this.canvas);b.appendChild(this.ctemp)};granule.prototype.randomCreateAllBall=function(){var b=[];this.ext_balls=[];for(var a=0;a<this.cg;a++){var c={};c=this.randomCreateOneBall();b.push(c)}this.balls=b};granule.prototype.randomCreateOneBall=function(a){var b={};b.stauts="0";b.color=this.color;b.r=this.radius;b.x=this.rdmmm(0,this.cw);b.y=this.rdmmm(0,this.ch);b.txb=b.x;b.tyb=b.y;b.txc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.tyc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.td=(this.duration+this.rdmmm(-this.duration/2,this.duration/2))*60;b.tt=this.rdmmm(0,b.td);if(this.tweenType){b.tp=this.tweenType}else{b.tp=this.TWEEN[this.rdmmm(0,this.TWEEN.length)]}if(a){this.ext_balls.push(b)}return b};granule.prototype.updataBallPosition=function(a){var d=this[a.tp](a.tt,a.txb,a.txc,a.td);var c=this[a.tp](a.tt,a.tyb,a.tyc,a.td);if(d<0){d=-d}if(c<0){c=-c}if(d>this.cw){d=2*this.cw-d}if(c>this.ch){c=2*this.ch-c}a.x=d;a.y=c;if(a.stauts==0){if(++a.tt>=a.td){a.txb=a.x;a.tyb=a.y;a.txc=this.rdmmm(-this.rangeRadius,this.rangeRadius);a.tyc=this.rdmmm(-this.rangeRadius,this.rangeRadius);a.tt=0}}else{if(a.stauts==1){if(a.tt<a.td){a.tt++}}else{if(a.stauts==2){if(++a.tt>=a.td){a.txb=a.x;a.tyb=a.y;a.txc=this.rdmmm(-((Math.max(1.5,this.ext_balls.length/60))*this.rangeRadius),((Math.max(1.5,this.ext_balls.length/60))*this.rangeRadius));a.tyc=this.rdmmm(-((Math.max(1.5,this.ext_balls.length/60))*this.rangeRadius),((Math.max(1.5,this.ext_balls.length/60))*this.rangeRadius));a.tt=0}}}}return a};granule.prototype.drawbg=function(){this.cc.globalAlpha=1;this.cc.fillStyle=this.bgcolor;this.cc.fillRect(0,0,this.cw,this.ch)};granule.prototype.drawBalls=function(){this.drawbg();this.cc.globalAlpha=this.opacity;for(var a=0;a<this.balls.length;a++){var b=this.balls[a];this.cc.beginPath();this.cc.fillStyle=b.color||this.color;this.cc.arc(b.x,b.y,b.r,0,Math.PI*2);this.cc.closePath();this.cc.fill()}for(var a=0;a<this.ext_balls.length;a++){var b=this.ext_balls[a];this.cc.beginPath();this.cc.fillStyle=b.color||this.color;this.cc.arc(b.x,b.y,b.r,0,Math.PI*2);this.cc.closePath();this.cc.fill()}};granule.prototype.startAnimation=function(){var a=this;var b=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;c();function c(){for(var d=0;d<a.balls.length;d++){var e=a.balls[d];var f=a.updataBallPosition(e);a.balls[d]=f}for(var d=0;d<a.ext_balls.length;d++){var e=a.ext_balls[d];var f=a.updataBallPosition(e);a.ext_balls[d]=f;if(2===a.ext_balls[d].stauts&&(a.ext_balls[d].x<0||a.ext_balls[d].y<0||a.ext_balls[d].x>a.cw||a.ext_balls[d].y>a.ch)){a.ext_balls.splice(d,1)}}a.drawBalls();b(c)}};granule.prototype.closeAniStauts=function(){var d=this.balls;var c=this.ext_balls;for(var a=0;a<d.length;a++){if(d[a].stauts==1){var b=d[a];b.stauts=0;b.color="#FFFFFF";b.txb=b.x;b.tyb=b.y;b.txc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.tyc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.td=(this.duration+this.rdmmm(-this.duration/2,this.duration/2))*60;b.tt=0;if(this.tweenType){b.tp=this.tweenType}else{b.tp=this.TWEEN[this.rdmmm(0,this.TWEEN.length)]}}}for(var a=0;a<c.length;a++){if(c[a].stauts==1){var b=c[a];b.stauts=0;b.color="#FFFFFF";b.txb=b.x;b.tyb=b.y;b.txc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.tyc=this.rdmmm(-this.rangeRadius,this.rangeRadius);b.td=(this.duration+this.rdmmm(-this.duration/2,this.duration/2))*60;b.tt=0;if(this.tweenType){b.tp=this.tweenType}else{b.tp=this.TWEEN[this.rdmmm(0,this.TWEEN.length)]}c[a].stauts=2}}};granule.prototype.rect=function(u,o){var l=this.cw;var b=this.ch;var a=this.radius;var q=(b-(o*(a*2+2)))/2;var d=(l-(u*(a*2+2)))/2;var c=this.balls;for(var n=0;n<u;n++){for(var k=0;k<o;k++){var p=c[n*o+k]||this.randomCreateOneBall(1);p.stauts=1;p.tp=this.tweenAni;var m=p.x;var g=p.y;var f=(a*2+2)*n+d;var e=(a*2+2)*k+q;var t=f-m;var s=e-g;p.txb=p.x;p.tyb=p.y;p.txc=t;p.tyc=s;p.tt=0;p.td=this.duration/6*60}}};granule.prototype.circle=function(c){var a=this.cw;var b=this.ch;var c=this.radius;var e=(b-2*(c+2))/2;var d=(a-2*(c+2))/2;console.log(e+":"+d);var f=this.balls};granule.prototype.echo=function(o,a){var s=this.radius;this.c2.fillStyle="blue";this.c2.fillRect(0,0,this.cw,this.fontSize);this.c2.fillStyle="red";var g=o||"";var n=Math.ceil(this.c2.measureText(g).width);this.c2.fillText(g,10,this.fontSize/2);var l=(this.ch-this.fontSize)/2;var b=(this.cw>1220)?((this.cw-1220)/2):(25);var u=this.c2.getImageData(0,0,n,this.fontSize).data;var d=0;var z=s*2+2;var p=0;for(var t=0;t<n;t+=z){for(var q=0;q<this.fontSize;q+=z){var e=q*4*n+t*4;var m=u[e];if(m>200){var c=this.balls[d]||this.randomCreateOneBall(1);c.stauts=1;if(a=="error"){c.color="red"}c.tp=this.tweenAni;var w=c.x;var v=c.y;var y=t+b;var x=q+l;var h=y-w;var f=x-v;c.txb=c.x;c.tyb=c.y;c.txc=h;c.tyc=f;c.tt=0;c.td=this.duration/6*60;d++}}}};granule.prototype.easeInOutQuad=function(e,a,g,f){if((e/=f/2)<1){return g/2*e*e+a}return -g/2*((--e)*(e-2)-1)+a};granule.prototype.easeInOutCubic=function(e,a,g,f){if((e/=f/2)<1){return g/2*e*e*e+a}return g/2*((e-=2)*e*e+2)+a};granule.prototype.easeInOutBack=function(e,a,h,g,f){if(f==undefined){f=1.70158}if((e/=g/2)<1){return h/2*(e*e*(((f*=(1.525))+1)*e-f))+a}return h/2*((e-=2)*e*(((f*=(1.525))+1)*e+f)+2)+a};granule.prototype.easeOutBounce=function(e,a,g,f){if((e/=f)<(1/2.75)){return g*(7.5625*e*e)+a}else{if(e<(2/2.75)){return g*(7.5625*(e-=(1.5/2.75))*e+0.75)+a}else{if(e<(2.5/2.75)){return g*(7.5625*(e-=(2.25/2.75))*e+0.9375)+a}else{return g*(7.5625*(e-=(2.625/2.75))*e+0.984375)+a}}}};granule.prototype.rdmmm=function(b,a){return Math.floor(Math.random()*(a-b)+b)};